<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title></title>

<link href="css/style.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="js/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="js/shared.js"></script>
<script type="text/javascript" src="js/table.js"></script>

<script type="text/javascript">

var users;
var table;
var exportText;

function onload()
{
	table = new LoadableTable(document.getElementById("dataTable").children[0]);
	
	updateRows();
}

function updateRows()
{
	table.clear();
	table.setLoading(true);
	callAPI({request:"getPlayers"}, onUsersLoaded);
}

function onUsersLoaded(data)
{
	users = data;
	
	table.setLoading(false);
	table.clear();
	
	var X;
	var userRow;
	for(X in data)
	{
		userRow = table.createRow();
		fillRowWithUser(userRow, data[X]);
	}
}

function fillRowWithUser(tableRow, user)
{
	var soloStats = user.soloStats ? user.soloStats : {};
	var duoStats = user.duoStats ? user.duoStats : {};
	var cells = tableRow.getElementsByTagName("td");
	cells[0].innerHTML = user.name
	cells[1].innerHTML = safeStr(duoStats.score);
	cells[2].innerHTML = safeSlashNum(duoStats.wins, duoStats.games);
	cells[3].innerHTML = safeStr(soloStats.score);
	cells[4].innerHTML = safeSlashNum(soloStats.wins, soloStats.games);
}

function safeStr(obj)
{
	if(obj)
	{
		return Math.round(Number(obj));
	}
	return "";
}

function safeSlashNum(num1, num2)
{
	if(!num1) num1 = 0;
	if(!num2) num2 = 0;
	if(num1 == 0 && num2 == 0)
	{
		return "";
	}
	return num1 + " / " + num2;
}

function addPlayer()
{
	if(users == null)
	{
		alert("User loading in progress.");
		return;
	}
	var username = prompt("Enter your name to add : ", "your name here");
	if(username == null)
	{
		return;
	}
	if(findUserByName(users, username))
	{
		alert("User already exists : " +  username );
	}
	else
	{
		var yes = confirm("Do you really want to add new user '" + username+ "'?");
	   if( yes )
	   {
			callAPI({request:"addPlayer", name:username}, onUsersAdded);
	   }
	}
}

function onUsersAdded(data)
{
	updateRows();
}

function rebuiltStats()
{
	callAPI({request:"rebuiltMatchStats"}, onRebuiltMatchStats);
}

function onRebuiltMatchStats(ok)
{
	updateRows();
	alert(ok ? "Successful" : "Failed");
}


function exportData()
{
	if(exportText)
	{
		exportText.parentNode.removeChild(exportText);
	}
	callAPI({request:"getPlayersByIds"}, 
	function(data)
	{
		var docs = [];
		for (var X in data)
		{
			docs.push(data[X]);
		}
		var obj = {docs:docs};
		exportText = document.createTextNode(JSON.stringify(obj));
		document.body.appendChild(exportText);
	});
}

</script>
</head>
<body onload="onload();">
<div class="header"><a href="matches.html">Matches</a> | <a href="addmatch.html">Add Match</a>  | <a href="users.html">Players</a></div>
<br />
<table width="580" border="0" align="center" id="dataTable">
  <tr>
    <td colspan="5" align="center">Players<br />
      <a href="javascript:addPlayer()" class="tiny">Add player</a>  |
      <a href="javascript:rebuiltStats()" class="tiny">Rebuilt stats</a></td>
  </tr>
  <tr>
    <td bgcolor="#999999">Name</td>
    <td width="100" align="center" bgcolor="#999999">duo<br />
    score</td>
    <td width="100" align="center" bgcolor="#999999">duo<br />
    wins/games</td>
    <td width="100" align="center" bgcolor="#999999">solo<br />
    games</td>
    <td width="100" align="center" bgcolor="#999999">solo<br />
    win/games</td>
  </tr>
  <tr id="loadingRow">
    <td colspan="5" align="center" bgcolor="#FFCC00">Getting players...</td>
  </tr>
  <tr id="sampleRow">
    <td class="tableRow">NAME</td>
    <td align="center" class="tableRow">2</td>
    <td align="center" class="tableRow">1/2</td>
    <td align="center" class="tableRow">2</td>
    <td align="center" class="tableRow">1/2</td>
  </tr>
</table>
<p><a href="javascript:exportData(this)" class="tiny">Export</a></p>
</body>
</html>
