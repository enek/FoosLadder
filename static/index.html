<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
	<meta name="viewport" id="viewport" content="width=700;"/>
	<meta name="apple-mobile-web-app-capable" content="yes">
    
	<title>Foos Ladder</title>

	<link href="css/style.css" rel="stylesheet" type="text/css" />
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
	<link href="css/jquery-ui.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="jslib/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="jslib/jquery-ui-1.8.23.custom.min.js"></script>
<script type="text/javascript" src="jslib/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="jslib/jquery.sparkline.js"></script>
<script type="text/javascript" src="jslib/bootstrap.min.js"></script>
<script type="text/javascript" src="js/shared.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/matchesView.js"></script>
<script type="text/javascript" src="js/addMatchView.js"></script>
<script type="text/javascript" src="js/playersView.js"></script>
<script type="text/javascript" src="js/graphView.js"></script>

<script src="//connect.facebook.net/en_US/all.js"></script>

<script type="text/javascript">
var matchesView;
var playersView;
var addMatchView;
var facebookAccessToken;

var currentView;
var self = this;

function onLoad()
{
	
	var matchesTable = new LoadableTable(document.getElementById("matchesTable"));
	matchesView = new MatchesView(matchesTable);
	matchesView.loadPlayers = loadPlayers;
	matchesView.loadMatches = loadMatches;
	matchesView.hide();
	
	var playersTable = new LoadableTable(document.getElementById("playersTable").children[0]);
	playersView = new PlayersView(playersTable);
	playersView.loadPlayers = loadPlayers;
	playersView.hide();
	
	var addMatchTable = document.getElementById("addMatchTable").children[0];
	addMatchView = new AddMatchView(addMatchTable);
	addMatchView.loadPlayers = loadPlayers;
	addMatchView.onMatchAdded = onMatchAdded;
	addMatchView.hide();
	
	var graphDiv = $("#graphView");
	graphView = new GraphView(graphDiv);
	graphView.loadPlayers = loadPlayers;
	graphView.hide();
	
	
	var location = String(window.location);
	var hashPath = "";
	var hashIndex = location.indexOf("#");
	if(hashIndex >= 0)
	{
		hashPath = location.substring(hashIndex + 1);
	}
	var hashBits = hashPath.split("/");
	
	switch (hashBits[0])
	{
		case "match":
		case "matches":
			showMatches();
		break;
		case "addMatch":
			showAddMatch();
		break;
		case "graph":
			showGraph();
		break;
		default:
		showPlayers();
	}
	
	if(FACEBOOK_ENABLED)
	{
		FB.Event.subscribe('auth.statusChange', function(response)
		{
			if(response.authResponse != null)
			{
				facebookAccessToken = response.authResponse.accessToken;
			}
			else
			{
				facebookAccessToken = null;
			}
			setFacebookLoginStatusDisplay(facebookAccessToken ? true : false);
		});

		FB.init({
			appId      : FACEBOOK_APP_ID,
			channelUrl : FACEBOOK_APP_URL_PART,
			status     : true,
			cookie     : true,
			xfbml      : true
		});
	}
	else
	{
		setFacebookLoginStatusDisplay(true);
	}
}

function setFacebookLoginStatusDisplay(loggedIn)
{
	var loggedinButtons = document.getElementsByClassName("fbLoggedIn");
	setStyleDisplayOfList(loggedinButtons, loggedIn ? '' : 'none');
			
	var loggedoutButtons = document.getElementsByClassName("fbLoggedOut");
	setStyleDisplayOfList(loggedoutButtons, loggedIn ? 'none' : '');	
}

function setStyleDisplayOfList(nodelist, value)
{
	for(var i = nodelist.length - 1; i >= 0; i--)
	{
		var element = nodelist[i];
		element.style.display = value;
	}
}

function loadPlayers()
{
	callAPI({request:"getPlayers"}, self.onPlayersLoaded);
}

function onPlayersLoaded(players)
{
	graphView.setPlayers(players);
	matchesView.setPlayers(players);
	playersView.setPlayers(players);
	addMatchView.setPlayers(players);
}

function loadMatches()
{
	matchesView.onReloading();
	graphView.onReloading();
	callAPI({request:"getMatches"}, onMatchesLoaded);
}

function onMatchesLoaded(data)
{
	matchesView.setMatches(data);
	graphView.setMatches(data);
}

function onMatchAdded()
{
	matchesView.onReloading()
	loadPlayers();
	loadMatches();
	showMatches();
}

var lastMenu;

function setActiveMenu(newMenu)
{
	if(lastMenu)
	{
		lastMenu.removeClass("active");
	}
	lastMenu = newMenu;
	if(newMenu)
	{
		newMenu.addClass("active");
	}
}

function showMatches()
{
	setActiveMenu($("#matchesMenu"));
	setCurrentView(matchesView);
}

function showAddMatch()
{
	setActiveMenu($("#addMatchesMenu"));
	setCurrentView(addMatchView);
}

function showPlayers()
{
	setActiveMenu($("#playersMenu"));
	setCurrentView(playersView);
}

function showGraph()
{
	setActiveMenu($("#graphMenu"));
	setCurrentView(graphView);
}


function setCurrentView(view)
{
	if(currentView)
	{
		currentView.hide();
		hideActivePlayerSelectDialog();
	}
	currentView = view;
	if(currentView)
	{
		currentView.show();
	}
}


var activePlayerSelectDialog;

function showPlayerSelectionDialog(title, buttonObjs)
{
	hideActivePlayerSelectDialog();
	var dialogDiv = $(document.createElement('div'));
	activePlayerSelectDialog = dialogDiv;
	
	var dialogClickOutsideHandler = function(e)
	{
		if(dialogDiv.dialog('isOpen')
		&& !jQuery(e.target).is('.ui-dialog, a')
		&& !jQuery(e.target).closest('.ui-dialog').length)
		{
			hideActivePlayerSelectDialog();
		}
	}
	
	dialogDiv.dialog(
	{
		title:title,
		minWidth:480,
		position:['center', 40],
		open: function()
			{
			   jQuery('body').bind('click',	dialogClickOutsideHandler);
			},
		close: function()
			{
			   jQuery('body').unbind('click', dialogClickOutsideHandler);
			},
		buttons:buttonObjs
	});
	$(".ui-dialog-content").hide();	
}

function hideActivePlayerSelectDialog()
{
	if(activePlayerSelectDialog)
	{
		activePlayerSelectDialog.dialog("close");
		activePlayerSelectDialog = null;
	}
}
</script>
</head> 
<body onLoad="onLoad()"> 
<div id="fb-root"></div>
    <div class="container-narrow">
    
    
      <div class="navbar navbar-inner">
        <a class="brand" style="font-weight:bold">Foos Ladder</a>
      	<div >
        <ul class="nav">
          <li id="matchesMenu"><a href="javascript:showMatches()" >Matches</a></li>
          <li id="addMatchesMenu"><a href="javascript:showAddMatch()">Add Match</a></li>
          <li id="playersMenu"><a href="javascript:showPlayers()">Players</a></li>
          <li id="graphMenu"><a href="javascript:showGraph()">Graph</a></li>
        </ul>
        </div>
      </div>

<table class="table table-condensed table-hover table-striped" id="matchesTable" >
  <thead>
  <tr>
    <th>&nbsp;</th>
    <th colspan="2" class="rightCell">Yellow</th>
    <th>&nbsp;</th>
    <th colspan="2">White</th>
    <th>&nbsp;</th>
  </tr>
  </thead>
  <tbody>
  <tr id="loadingRow">
    <td colspan="7">Getting matches...</td>
  </tr>
  <tr id="sampleRow">
    <td class="tiny" style="width:80px"><matchDate>1, 1, 2012<br />18:00</matchDate></td>
    <td class="rightCell" style="width:60px"><leftScoreChange>11</leftScoreChange></td>
    <td class="rightCell"><leftAttacker>Left Attacker</leftAttacker><br />
    <leftDefender>Left Defender</leftDefender></td>
    <td style="width:60px" class="centerCell"><leftScore>10</leftScore> - <rightScore>9</rightScore></td>
    <td><rightAttacker>Right Attacker</rightAttacker><br />
    <rightDefender>Right Defender</rightDefender></td>
    <td style="width:60px"><rightScoreChange>-11</rightScoreChange></td>
    <td class="rightCell" style="width:80px"><commentToggle><a href="#"><span  style="color:#569; font-size:12px; text-decoration:none;"><span class=\"fb-comments-count\" data-href=\""+makeCommentURL(key)+"\"?</span> <i class="icon-comment"></i></span></a></commentToggle></td>
  </tr>
  <tr id="sampleComment">
    <td colspan="7">
		<div class="commentArea"></div>
    </td>
  </tr>
  </tbody>
</table>


<table id="playersTable" class="table table-bordered table-condensed table-hover table-striped" >
  <tr>
    <td colspan="6" align="center">
    <div class="btn-group tiny">
      <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
        <i class="icon-edit"></i>
        <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
          <li><a href="javascript:playersView.addPlayer()"><i class="icon-plus-sign"></i> Add player</a></li>
          <li><a href="javascript:playersView.loadPlayers()"><i class="icon-refresh"></i> Reload</a></li>
          <li class="divider"></li>
          
          <li><a href="javascript:playersView.rebuiltStats()"><i class="icon-repeat"></i> Rebuilt stats</a></li>
          <li><a href="javascript:playersView.repeatMatches()"><i class="icon-fast-forward"></i> Repeat matches</a></li>
      </ul>
    </div>
    </td>
  </tr>
  <tr id="headerRow">
    <th width="160" align="center" ><a href="javascript:playersView.toggleSortBy('name')">Name</a></th>
    <th width="100" align="center" ><a href="javascript:playersView.toggleSortBy('mixedStats.score')">mixed<br />
    rating</a></th>
    <th width="100" align="center" ><a href="javascript:playersView.toggleSortBy('duoStats.score')">duo<br />
    rating</a></th>
    <th width="100" align="center" >duo<br />
    <a href="javascript:playersView.toggleSortBy('duoStats.wins')">wins</a>/<a href="javascript:playersView.toggleSortBy('duoStats.games')">games</a></th>
    <th width="100" align="center" ><a href="javascript:playersView.toggleSortBy('soloStats.score')">solo<br />
    rating</a></th>
    <th width="100" align="center" >solo<br />
    <a href="javascript:playersView.toggleSortBy('soloStats.wins')">win</a>/<a href="javascript:playersView.toggleSortBy('soloStats.games')">games</a></th>
  </tr>
  <tr id="loadingRow">
    <td colspan="6" align="center" bgcolor="#FFCC00">Getting players...</td>
  </tr>
  <tr id="sampleRow">
    <td  style="text-align:left"><playerImage></playerImage> <playerName>NAME</playerName></td>
    <td ><mixedScore>3</mixedScore></td>
    <td ><duoScore>1</duoScore></td>
    <td ><duoWins>2/3</duoWins></td>
    <td ><soloScore>2</soloScore></td>
    <td ><soloWins>2/2</soloWins></td>
  </tr>
  <tr>
    <td colspan="7">
	<div class="fb-comments" data-href="http://foos.apelabs.net#players" data-num-posts="3" data-width="560" mobile="false"></div>
    </td>
  </tr>
</table>


<table border="0" align="center" cellpadding="4" cellspacing="0" id="addMatchTable">
  <tr>
    <td align="right" bgcolor="#FFFF55"><strong>Yellow</strong></td>
    <td align="center" bgcolor="#FFFF55">&nbsp;</td>
    <td width="40" rowspan="2" align="center">
      VS    </td>
    <td align="center" bgcolor="#AAAAAA">&nbsp;</td>
    <td align="left" bgcolor="#AAAAAA"><strong>White</strong></td>
  </tr>
  <tr>
  	<td width="150" height="80" align="right"  bgcolor="#EEEE44" id='leftRating'>
  	  <a href="javascript:$('#myModal').modal('show')">test</a>
  	  <a href="javascript:addMatchView.selectPlayer(true, 0)"><span class="leftAttacker">Left offence</span></a>
  	  <br /><br/>
  	  <a href="javascript:addMatchView.selectPlayer(true, 1)"><span class="leftDefender">Left defender</span></a>
      </td>
    <td width="50" align="right" bgcolor="#FFFF55">
      <br>
      <select name="leftScore" id="leftScore">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option selected>10</option>
      </select>[<span id='leftExpectedScore'>x</span>]
    </td>
    <td width="50" bgcolor="#AAAAAA">
    <br>
    <select name="rightScore" id="rightScore">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option selected>10</option>
      </select>[<span id='rightExpectedScore'>x</span>]
    </td>
    <td width="150" align="left" >
      <a href="javascript:addMatchView.selectPlayer(false, 0)"><span class="rightAttacker">Right offence</span></a>
      <br /><br/>
      <a href="javascript:addMatchView.selectPlayer(false, 1)"><span class="rightDefender">Right defender</span></a>
    </td>
  </tr>
  <tr>
    <td colspan="5">
    Date: 
      now?
      <input name="dateNow" type="checkbox" id="dateNow" checked="checked" onchange="addMatchView.dateNowChanged();"/>
      <input type="text" id="datePicker" name="datePicker" style="width: 140px" />
    </td>
  </tr>
  <tr>
    <td colspan="5" align="center"><div class="fb-login-button fbLoggedOut" data-show-faces="false" data-width="200" data-max-rows="1">Login to Submit</div> <div class="fbLoggedIn" ><input type="submit" name="submit" id="submit" value="Submit" onClick="addMatchView.onSubmit()" class="btn btn-primary"/> </div></td>
  </tr>
</table>

<div id="graphView" style="text-align:center"><a href="javascript:graphView.selectPlayers();">select players</a><br>
  <br>
<graphSelectedPlayers>players...</graphSelectedPlayers>
<br>
<br>
<div id="graphLoading">Loading...</div>
</div>


<div id="myModal" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Modal header</h3>
  </div>
  <div class="modal-body">
    <p>
    
    <a class="btn"><img src="http://graph.facebook.com/luaye/picture?type=square" width='25' height='25'/> Lu Aye Oo</a>
    <a class="btn btn-info"><img src="http://graph.facebook.com/luaye/picture?type=square" width='25' height='25'/> Lu Aye Oo</a>
    
    </p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary">Save changes</button>
  </div>
</div>
<script>

/*
document.getElementById("matchesTable").style.display = 'none';
document.getElementById("playersTable").style.display = 'none';
document.getElementById("addMatchTable").style.display = 'none';
*/
</script>
</div>
</body> 
</html>
